<%= form_with model: [:admin, @episode], local: true, class: "p-6 space-y-6" do |form| %>

  <div class="grid grid-cols-1 gap-6 sm:grid-cols-2">
    <!-- Episode Name -->
    <div class="sm:col-span-2">
      <%= form.label :name, "Episode Title", class: "block text-sm font-medium text-gray-700 mb-2" do %>
        Episode Title <span class="text-red-500">*</span>
      <% end %>
      <%= form.text_field :name, class: "w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 #{'border-red-500' if @episode.errors[:name].any?}", placeholder: "Enter episode title" %>
      <% if @episode.errors[:name].any? %>
        <p class="mt-1 text-sm text-red-600"><%= @episode.errors[:name].join(', ') %></p>
      <% end %>
    </div>

    <!-- Episode Number -->
    <div>
      <%= form.label :number, "Episode Number", class: "block text-sm font-medium text-gray-700 mb-2" %>
      <%= form.number_field :number, class: "w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 #{'border-red-500' if @episode.errors[:number].any?}", placeholder: @suggested_number ? "Suggested: #{@suggested_number}" : "1" %>
      <% if @episode.errors[:number].any? %>
        <p class="mt-1 text-sm text-red-600"><%= @episode.errors[:number].join(', ') %></p>
      <% elsif @suggested_number && @episode.draft? %>
        <p class="mt-1 text-sm text-gray-500">Next available number: <%= @suggested_number %> (will auto-assign if left empty when publishing)</p>
      <% end %>
    </div>

    <!-- Status -->
    <div>
      <%= form.label :status, "Status", class: "block text-sm font-medium text-gray-700 mb-2" %>
      <%= form.select :status, Episode.statuses.keys.map { |s| [s.humanize, s] }, {}, class: "w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 #{'border-red-500' if @episode.errors[:status].any?}" %>
      <% if @episode.errors[:status].any? %>
        <p class="mt-1 text-sm text-red-600"><%= @episode.errors[:status].join(', ') %></p>
      <% end %>
    </div>

    <!-- Preview URL (shown when status is preview) -->
    <div class="sm:col-span-2 preview-token-section <%= 'hidden' unless @episode.preview? %>" data-controller="preview-token">
      <%= form.label :preview_url, "Preview URL", class: "block text-sm font-medium text-gray-700 mb-2" %>
      <div class="flex space-x-2">
        <input type="text" 
               value="<%= @episode.preview? && @episode.preview_token.present? ? episode_url(@episode.preview_token) : '' %>" 
               readonly 
               class="flex-1 px-3 py-2 border border-gray-300 rounded-md shadow-sm bg-gray-50 text-gray-600" 
               placeholder="Preview URL will be generated automatically"
               data-preview-token-target="input" />
        <button type="button" 
                class="admin-button admin-button-primary text-sm px-4 py-2"
                data-action="click->preview-token#copyToken">
          <i class="fas fa-copy mr-1.5"></i>
          <span>Copy URL</span>
        </button>
      </div>
      <p class="mt-1 text-sm text-gray-500">This URL can be shared for preview access. It cannot be modified.</p>
    </div>

    <!-- Slug -->
    <div>
      <%= form.label :slug, "Slug", class: "block text-sm font-medium text-gray-700 mb-2" do %>
        Slug <span class="text-red-500">*</span>
      <% end %>
      <%= form.text_field :slug, class: "w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 #{'border-red-500' if @episode.errors[:slug].any?}", placeholder: "episode-slug" %>
      <% if @episode.errors[:slug].any? %>
        <p class="mt-1 text-sm text-red-600"><%= @episode.errors[:slug].join(', ') %></p>
      <% end %>
    </div>

    <!-- File Drag & Drop Upload Area -->
    <div class="sm:col-span-2 mb-6"
         data-controller="file-upload"
         data-file-upload-max-file-size-value="100000000"
         data-file-upload-allowed-types-value='["audio/mpeg", "audio/wav", "audio/m4a", "audio/aac"]'>
      <div class="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center hover:border-blue-400 transition-colors duration-200"
           data-file-upload-target="dropZone">
        
        <!-- Default State -->
        <div data-file-upload-target="default" class="space-y-3">
          <svg class="mx-auto h-12 w-12 text-gray-400" stroke="currentColor" fill="none" viewBox="0 0 48 48">
            <path d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8m-12 4h.02" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
          </svg>
          <div class="text-gray-600">
            <label for="file-upload" class="cursor-pointer">
              <span class="font-medium text-blue-600 hover:text-blue-500">Click to select file</span>
              <span class="text-gray-500"> or drag file here</span>
            </label>
            <input data-file-upload-target="fileInput" id="file-upload" name="file-upload" type="file" class="sr-only" accept="audio/*" />
          </div>
          <p class="text-xs text-gray-500">Supports MP3, WAV, M4A and other audio formats</p>
        </div>

        <!-- Drag Over State -->
        <div data-file-upload-target="dragOver" class="space-y-3 hidden">
          <svg class="mx-auto h-12 w-12 text-blue-500" stroke="currentColor" fill="none" viewBox="0 0 48 48">
            <path d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8m-12 4h.02" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
          </svg>
          <p class="text-blue-600 font-medium">Release mouse to upload file</p>
        </div>

        <!-- Ready State (file selected, not uploaded yet) -->
        <div data-file-upload-target="ready" class="space-y-3 hidden">
          <p class="text-gray-700"><span class="font-medium">Selected:</span> <span data-file-upload-target="readyInfo"></span></p>
          <div class="flex items-center justify-center space-x-4">
            <button type="button" class="px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700" data-file-upload-target="uploadButton">Upload</button>
            <button type="button" class="text-sm text-blue-600 hover:text-blue-500" data-action="click->file-upload#reset">Choose another file</button>
          </div>
        </div>

        <!-- Upload Progress State -->
        <div data-file-upload-target="uploading" class="space-y-3 hidden">
          <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto"></div>
          <p class="text-blue-600 font-medium">Uploading...</p>
          <div class="w-full bg-gray-200 rounded-full h-2">
            <div class="bg-blue-600 h-2 rounded-full transition-all duration-300" style="width: 0%" data-file-upload-target="progressBar"></div>
          </div>
          <p class="text-sm text-gray-500" data-file-upload-target="status">Preparing upload</p>
        </div>

        <!-- Upload Success State -->
        <div data-file-upload-target="success" class="space-y-3 hidden">
          <svg class="mx-auto h-12 w-12 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
          </svg>
          <p class="text-green-600 font-medium">Upload successful!</p>
          <p class="text-sm text-gray-500" data-file-upload-target="fileInfo"></p>
          <button type="button" class="text-sm text-blue-600 hover:text-blue-500" data-action="click->file-upload#reset">Upload another file</button>
        </div>

        <!-- Upload Error State -->
        <div data-file-upload-target="error" class="space-y-3 hidden">
          <svg class="mx-auto h-12 w-12 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
          </svg>
          <p class="text-red-600 font-medium">Upload failed</p>
          <p class="text-sm text-gray-500" data-file-upload-target="errorMessage"></p>
          <button type="button" class="text-sm text-blue-600 hover:text-blue-500" data-action="click->file-upload#reset">Retry</button>
        </div>
      </div>
    </div>

    <!-- Audio File URI -->
    <div class="sm:col-span-2">
      <%= form.label :file_uri, "Audio File URI", class: "block text-sm font-medium text-gray-700 mb-2" %>
      <%= form.text_field :file_uri, class: "w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 #{'border-red-500' if @episode.errors[:file_uri].any?}", placeholder: "https://example.com/audio.mp3" %>
      <% if @episode.errors[:file_uri].any? %>
        <p class="mt-1 text-sm text-red-600"><%= @episode.errors[:file_uri].join(', ') %></p>
      <% end %>
      <p class="mt-1 text-sm text-gray-500">URL to the audio file</p>
    </div>

    <!-- Duration -->
    <div>
      <%= form.label :duration, "Duration (seconds)", class: "block text-sm font-medium text-gray-700 mb-2" %>
      <%= form.number_field :duration, class: "w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 #{'border-red-500' if @episode.errors[:duration].any?}", placeholder: "3600" %>
      <% if @episode.errors[:duration].any? %>
        <p class="mt-1 text-sm text-red-600"><%= @episode.errors[:duration].join(', ') %></p>
      <% end %>
    </div>

    <!-- File Length -->
    <div>
      <%= form.label :length, "File Length (bytes)", class: "block text-sm font-medium text-gray-700 mb-2" %>
      <%= form.number_field :length, class: "w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 #{'border-red-500' if @episode.errors[:length].any?}", placeholder: "52428800" %>
      <% if @episode.errors[:length].any? %>
        <p class="mt-1 text-sm text-red-600"><%= @episode.errors[:length].join(', ') %></p>
      <% end %>
      <p class="mt-1 text-sm text-gray-500">File size in bytes</p>
    </div>

    <!-- Cover URL -->
    <div>
      <%= form.label :cover_url, "Cover Image URL", class: "block text-sm font-medium text-gray-700 mb-2" %>
      <%= form.text_field :cover_url, class: "w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 #{'border-red-500' if @episode.errors[:cover_url].any?}", placeholder: "https://example.com/cover.jpg" %>
      <% if @episode.errors[:cover_url].any? %>
        <p class="mt-1 text-sm text-red-600"><%= @episode.errors[:cover_url].join(', ') %></p>
      <% end %>
    </div>

    <!-- Published At -->
    <div>
      <%= form.label :published_at, "Published At", class: "block text-sm font-medium text-gray-700 mb-2" %>
      <%= form.datetime_local_field :published_at, class: "w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 #{'border-red-500' if @episode.errors[:published_at].any?}" %>
      <% if @episode.errors[:published_at].any? %>
        <p class="mt-1 text-sm text-red-600"><%= @episode.errors[:published_at].join(', ') %></p>
      <% end %>
    </div>

    <!-- Keywords -->
    <div class="sm:col-span-2">
      <%= form.label :keywords, "Keywords", class: "block text-sm font-medium text-gray-700 mb-2" %>
      <%= form.text_field :keywords, class: "w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 #{'border-red-500' if @episode.errors[:keywords].any?}", placeholder: "podcast, technology, programming" %>
      <% if @episode.errors[:keywords].any? %>
        <p class="mt-1 text-sm text-red-600"><%= @episode.errors[:keywords].join(', ') %></p>
      <% end %>
    </div>

    <!-- Summary -->
    <div class="sm:col-span-2">
      <%= form.label :summary, "Summary", class: "block text-sm font-medium text-gray-700 mb-2" %>
      <%= form.text_area :summary, rows: 3, class: "w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 #{'border-red-500' if @episode.errors[:summary].any?}", placeholder: "Brief summary of the episode..." %>
      <% if @episode.errors[:summary].any? %>
        <p class="mt-1 text-sm text-red-600"><%= @episode.errors[:summary].join(', ') %></p>
      <% end %>
    </div>

    <!-- Description -->
    <div class="sm:col-span-2" data-controller="easymde">
      <%= form.label :desc, "Description", class: "block text-sm font-medium text-gray-700 mb-2" %>
      <%= form.text_area :desc, rows: 6, class: "w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 #{'border-red-500' if @episode.errors[:desc].any?}", placeholder: "Detailed description of the episode content...", data: { easymde_target: "textarea" } %>
      <% if @episode.errors[:desc].any? %>
        <p class="mt-1 text-sm text-red-600"><%= @episode.errors[:desc].join(', ') %></p>
      <% end %>
      <p class="mt-1 text-sm text-gray-500">Supports Markdown formatting with rich text editor</p>
    </div>
  </div>

  <!-- Form Actions -->
  <div class="flex justify-end space-x-3 pt-6 border-t border-gray-200">
    <%= link_to "Cancel", admin_episodes_path, class: "admin-button bg-white border border-gray-300 hover:bg-gray-50 text-gray-700" %>
    <%= form.submit submit_text, class: "admin-button admin-button-primary" %>
  </div>
<% end %>


